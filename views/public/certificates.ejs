<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - <%= contactInfo ? contactInfo.company_name : 'UCC Engineering' %></title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('../partials/header', { contactInfo }) %>
    
    <main>
        <section class="page-header">
            <div class="container">
                <h1><%= title %></h1>
                <p>Our certifications and downloadable resources</p>
            </div>
        </section>

        <% if (certificates && certificates.length > 0) { %>
        <section class="certificates-section" style="padding: 60px 0;">
            <div class="container">
                <h2 class="section-title">Our Certificates</h2>
                <div class="certificates-list">
                    <% certificates.forEach(function(cert, index) { %>
                    <div class="certificate-card animate-fade-in" style="animation-delay: <%= index * 0.1 %>s; margin-bottom: 30px;">
                        <div class="certificate-icon">üìÑ</div>
                        <h3><%= cert.title %></h3>
                        <% if (cert.description) { %>
                        <p><%= cert.description %></p>
                        <% } %>
                        
                        <% 
                        // Check if it's an image file
                        const isImage = cert.file_path && (
                            cert.file_path.toLowerCase().endsWith('.jpg') || 
                            cert.file_path.toLowerCase().endsWith('.jpeg') || 
                            cert.file_path.toLowerCase().endsWith('.png') || 
                            cert.file_path.toLowerCase().endsWith('.gif') ||
                            cert.file_path.toLowerCase().endsWith('.webp')
                        );
                        const isPDF = cert.file_path && cert.file_path.toLowerCase().endsWith('.pdf');
                        %>
                        
                        <% if (isImage) { %>
                        <!-- Certificate Image Preview -->
                        <div class="certificate-preview" data-image-path="<%= cert.file_path %>" data-image-title="<%= cert.title %>">
                            <img src="<%= cert.file_path %>" alt="<%= cert.title %>" loading="lazy">
                            <div class="certificate-preview-overlay">
                                <span>üîç View Full Size</span>
                            </div>
                        </div>
                        <a href="<%= cert.file_path %>" class="btn btn-primary btn-small" target="_blank" download style="margin-top: 10px;">Download Image</a>
                        <% } else if (isPDF) { %>
                        <!-- PDF Viewer with Controls -->
                        <div class="certificate-viewer" style="margin: 20px 0; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; position: relative;">
                            <div class="pdf-viewer-controls">
                                <button class="pdf-control-btn" data-pdf-path="<%= cert.file_path %>">üìÇ Open</button>
                                <a href="<%= cert.file_path %>" class="pdf-control-btn" download style="text-decoration: none; display: inline-block;">üíæ Download</a>
                            </div>
                            <iframe src="<%= cert.file_path %>" style="width: 100%; height: 600px; border: none;" title="<%= cert.title %>"></iframe>
                        </div>
                        <% } else { %>
                        <!-- Generic File -->
                        <a href="<%= cert.file_path %>" class="btn btn-primary btn-small" target="_blank" download style="margin-top: 10px;">Download File</a>
                        <% } %>
                        
                        <p class="upload-date">Uploaded: <%= new Date(cert.upload_date).toLocaleDateString() %></p>
                    </div>
                    <% }); %>
                </div>
            </div>
        </section>
        <% } %>

        <% if (downloads && downloads.length > 0) { %>
        <section class="downloads-section" style="padding: 60px 0; background: #f8f9fa;">
            <div class="container">
                <h2 class="section-title">Downloads</h2>
                <div class="downloads-list">
                    <% downloads.forEach(function(download, index) { %>
                    <div class="download-card animate-fade-in" style="animation-delay: <%= index * 0.1 %>s">
                        <div class="download-icon">üìÅ</div>
                        <h3><%= download.title %></h3>
                        <% if (download.category) { %>
                        <span class="category-badge"><%= download.category %></span>
                        <% } %>
                        <% if (download.description) { %>
                        <p><%= download.description %></p>
                        <% } %>
                        <a href="<%= download.file_path %>" class="btn btn-primary btn-small" target="_blank" download>Download</a>
                    </div>
                    <% }); %>
                </div>
            </div>
        </section>
        <% } %>

        <% if ((!certificates || certificates.length === 0) && (!downloads || downloads.length === 0)) { %>
        <section style="padding: 80px 0; text-align: center;">
            <div class="container">
                <p>No certificates or downloads available at this time. Please check back later.</p>
            </div>
        </section>
        <% } %>
    </main>
    
    <!-- Lightbox Modal for Certificate Images -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close">&times;</span>
        <img id="lightbox-img" src="" alt="" onclick="event.stopPropagation()">
        <div id="lightbox-caption" class="lightbox-caption"></div>
        <div class="lightbox-controls" onclick="event.stopPropagation()">
            <button class="lightbox-btn" onclick="zoomOut()" title="Zoom Out (-)">üîç-</button>
            <button class="lightbox-btn" onclick="resetZoom()" title="Reset (0)">‚Ü∫</button>
            <button class="lightbox-btn" onclick="zoomIn()" title="Zoom In (+)">üîç+</button>
            <button class="lightbox-btn" onclick="rotateImage()" title="Rotate (R)">‚Üª</button>
        </div>
    </div>
    
    <%- include('../partials/footer', { contactInfo }) %>
    
    <script src="/js/main.js"></script>
    <script>
    // Safely handle certificate preview clicks using event delegation
    document.addEventListener('DOMContentLoaded', function() {
        // Handle certificate preview clicks
        document.querySelectorAll('.certificate-preview').forEach(function(preview) {
            preview.addEventListener('click', function() {
                const imagePath = this.getAttribute('data-image-path');
                const imageTitle = this.getAttribute('data-image-title');
                if (imagePath && imageTitle) {
                    openLightbox(imagePath, imageTitle);
                }
            });
        });
        
        // Handle PDF open button clicks
        document.querySelectorAll('.pdf-control-btn[data-pdf-path]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const pdfPath = this.getAttribute('data-pdf-path');
                if (pdfPath) {
                    window.open(pdfPath, '_blank');
                }
            });
        });
    });
    </script>
</body>
</html>
